{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://soda.io/soda_data_contract_json_schema_1_0_0.json",
    "title": "Soda data contract style 3",
    "description": "A data contract",
    "type": "object",
    "additionalProperties": false,
    "properties": {
      "dataset": {
        "description": "The name of the dataset",
        "type": "string"
      },
      "dataset_prefix": {
        "description": "The prefix of the dataset",
        "type": "array",
        "items": {
          "type": [
            "string"
          ]
        },
        "minItems": 1
      },
      "data_source": {
        "description": "The name of the data_source",
        "type": "string"
      },
      "schema": {
        "description": "The name of the schema within the data source (on bigquery, this schema property this refers to a dataset)",
        "type": "string"
      },
      "description": {
        "description": "The description of the dataset",
        "type": "string"
      },
      "columns": {
        "description": "The list of columns, also known as 'the schema' of the dataset.",
        "type": "array",
        "items": {
          "type": "object",
          "allOf": [
            {
              "type": "object",
              "required": [
                "name"
              ],
              "properties": {
                "name": {
                  "description": "The name of the column as in the SQL data_source",
                  "type": "string"
                },
                "description": {
                  "description": "The description to be used anywhere this column is shown to users",
                  "type": "string"
                },
                "data_type": {
                  "description": "The SQL data type as in the data_source",
                  "anyOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "string",
                      "enum": [
                        "VARCHAR",
                        "CHAR",
                        "TEXT",
                        "STRING",
                        "INT",
                        "SMALLINT",
                        "TINYINT",
                        "BIGINT",
                        "INTEGER",
                        "DECIMAL",
                        "NUMERIC",
                        "DOUBLE",
                        "PRECISION",
                        "DOUBLE PRECISION",
                        "FLOAT",
                        "FLOAT4",
                        "FLOAT8",
                        "REAL",
                        "CLOB",
                        "BLOB",
                        "BINARY",
                        "VARBINARY",
                        "JSON",
                        "JSONB",
                        "XML",
                        "BOOLEAN",
                        "DATE",
                        "TIME",
                        "TIMESTAMP",
                        "TIMESTAMP_TZ"
                      ]
                    }
                  ]
                },
                "character_maximum_length": {
                  "description": "Length is only checked by the schema check if character_maximum_length is specified in the column and supported by the data source.",
                  "type": "number"
                },
                "optional": {
                  "description": "When set to true, the schema check will not fail if the column is not present. Default is required.",
                  "type": "boolean"
                },
                "checks": {
                  "description": "Checks for this column",
                  "type": "array",
                  "additionalItems": false,
                  "minItems": 1,
                  "items": {
                    "anyOf": [
                      {
                        "type": "object",
                        "properties": {
                          "missing": {
                            "oneOf": [
                              {
                                "type": "object",
                                "additionalProperties": false,
                                "properties": {
                                  "name": {
                                    "description": "The display name for the check used in Soda Cloud",
                                    "type": "string"
                                  },
                                  "attributes": {
                                    "$ref": "#/$defs/attributes"
                                  },
                                  "threshold": {
                                    "$ref": "#/$defs/threshold"
                                  },
                                  "filter": {
                                    "description": "Specifies a sql expression filter that should be applied on the metric",
                                    "type": "string"
                                  },
                                  "missing_values": {
                                    "description": "Customized list of missing values. NULL is always considered missing so that does not have to be specified. If no customization is needed, consider specifying not_null:true instead. Implies a missing_count check in Soda.",
                                    "type": "array",
                                    "items": {
                                      "type": [
                                        "integer",
                                        "string"
                                      ]
                                    }
                                  },
                                  "missing_regex_sql": {
                                    "description": "Customized SQL regex to identify missing values. The flavor of regex depends on the SQL engine / data_source. NULL is always considered missing so that does not have to be specified. Implies a missing_count check in Soda.",
                                    "type": "string"
                                  }
                                }
                              },
                              {
                                "type": "null"
                              }
                            ]
                          },
                          "invalid": {
                            "oneOf": [
                              {
                                "type": "object",
                                "additionalProperties": false,
                                "properties": {
                                  "name": {
                                    "description": "The display name for the check used in Soda Cloud",
                                    "type": "string"
                                  },
                                  "attributes": {
                                    "$ref": "#/$defs/attributes"
                                  },
                                  "threshold": {
                                    "$ref": "#/$defs/threshold"
                                  },
                                  "filter": {
                                    "description": "Specifies a sql expression filter that should be applied on the metric",
                                    "type": "string"
                                  },
                                  "valid_values": {
                                    "description": "A list of valid values. Only supports all strings or all numbers. Implies an invalid_count check in Soda.",
                                    "type": "array",
                                    "items": {
                                      "type": [
                                        "number",
                                        "string"
                                      ]
                                    }
                                  },
                                  "valid_regex": {
                                    "description": "A SQL regular expression that matches valid values. Implies a valid_count check in Soda. All (in)valid_* configs are combined in a single invalid_count check.",
                                    "type": "string"
                                  },
                                  "valid_format": {
                                    "description": "A named regular expression that specifies valid values.",
                                    "$ref": "#/$defs/format"
                                  },
                                  "invalid_values": {
                                    "description": "A list of valid values. Only supports all strings or all numbers. Implies an invalid_count check in Soda.",
                                    "type": "array",
                                    "items": {
                                      "type": [
                                        "number",
                                        "string"
                                      ]
                                    }
                                  },
                                  "invalid_regex": {
                                    "description": "A regular expression that specifies valid values.",
                                    "type": "string"
                                  },
                                  "invalid_format": {
                                    "description": "A named regular expression that specifies invalid values.",
                                    "$ref": "#/$defs/format"
                                  }
                                }
                              },
                              {
                                "type": "null"
                              }
                            ]
                          }
                        },
                        "additionalProperties": false
                      }
                    ]
                  }
                }
              }
            }
          ]
        }
      },
      "checks": {
        "description": "A list of checks for this dataset executed by a Soda",
        "type": "array",
        "minItems": 1,
        "additionalItems": false,
        "items": {
          "anyOf": [
            {
              "type": "object",
              "properties": {
                "row_count": {
                  "oneOf": [
                    {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "name": {
                          "description": "The display name for the check used in Soda Cloud",
                          "type": "string"
                        },
                        "attributes": {
                          "$ref": "#/$defs/attributes"
                        },
                        "threshold": {
                          "$ref": "#/$defs/threshold"
                        },
                        "filter": {
                          "description": "Specifies a sql expression filter that should be applied on the metric",
                          "type": "string"
                        }
                      }
                    },
                    {
                      "type": "null"
                    }
                  ]
                }
              },
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "schema": {
                  "oneOf": [
                    {
                      "type": "object",
                      "additionalProperties": false,
                      "description": "Use a schema check to validate the presence, absence or position of columns in a dataset, or to validate the type of data column contains. See documentation for more details: https://docs.soda.io/soda-cl/schema.html",
                      "properties": {
                        "name": {
                          "description": "The display name for the check used in Soda Cloud",
                          "type": "string"
                        },
                        "attributes": {
                          "$ref": "#/$defs/attributes"
                        },
                        "threshold": {
                          "$ref": "#/$defs/threshold"
                        },
                        "filter": {
                          "description": "Specifies a sql expression filter that should be applied on the metric",
                          "type": "string"
                        },
                        "extra_columns": {
                          "description": "Allow columns that are not in the schema",
                          "type": "boolean"
                        }
                      }
                    },
                    {
                      "type": "null"
                    }
                  ]
                }
              },
              "additionalProperties": false
            }
          ]
        }
      }
    },
    "required": [
      "dataset",
      "columns",
      "dataset_prefix",
      "data_source"
    ],
    "$defs": {
      "generic_check_properties": {
        "description": "NOT USED YET, problem with inheritance and additionalProperties",
        "type": "object",
        "properties": {
          "name": {
            "description": "The display name for the check used in Soda Cloud",
            "type": "string"
          },
          "attributes": {
            "$ref": "#/$defs/attributes"
          },
          "threshold": {
            "$ref": "#/$defs/threshold"
          },
          "filter": {
            "description": "Specifies a sql expression filter that should be applied on the metric",
            "type": "string"
          }
        }
      },
      "numeric_range": {
        "anyOf": [
          {
            "type": "array",
            "items": {
              "type": "number"
            },
            "minItems": 2,
            "maxItems": 2
          }
        ]
      },
      "format": {
        "type": "string",
        "enum": [
          "integer",
          "positive integer",
          "negative integer",
          "decimal",
          "positive decimal",
          "negative decimal",
          "decimal point",
          "positive decimal point",
          "negative decimal point",
          "decimal comma",
          "positive decimal comma",
          "negative decimal comma",
          "percentage",
          "positive percentage",
          "negative percentage",
          "percentage point",
          "positive percentage point",
          "negative percentage point",
          "percentage comma",
          "positive percentage comma",
          "negative percentage comma",
          "money",
          "money point",
          "money comma",
          "date us",
          "date eu",
          "date inverse",
          "date iso 8601",
          "time 24h",
          "time 24h nosec",
          "time 12h",
          "time 12h nosec",
          "timestamp 24h",
          "timestamp 12h",
          "uuid",
          "ip address",
          "ipv4 address",
          "ipv6 address",
          "email",
          "phone number",
          "credit card number"
        ]
      },
      "attributes": {
        "type": "object"
      },
      "threshold": {
        "type": "object",
        "additionalProperties": false,
        "description": "The threshold for the check. See documentation for more details: https://docs.soda.io/#thresholds",
        "properties": {
          "metric": {
            "description": "The type of the metric value to check",
            "enum": [
              "count",
              "percent"
            ]
          },
          "must_be": {
            "description": "YY The value the check metric (as specified in the type) must have for the check to pass; The check passes if the metric has the specified value, and fails otherwise; https://docs.soda.io/#thresholds",
            "type": "number"
          },
          "must_not_be": {
            "description": "The value that the check metric (as specified in the type) may not have. The check passes if the metric doesn't have this value and fails otherwise.",
            "type": "number"
          },
          "must_be_greater_than": {
            "description": "Specifies the threshold for the check. The check fails if the metric value is greater than the specified threshold value.",
            "type": "number"
          },
          "must_be_greater_than_or_equal": {
            "description": "Specifies the threshold for the check. The check fails if the metric value is greater than or equal to the specified threshold value.",
            "type": "number"
          },
          "must_be_less_than": {
            "description": "Specifies the threshold for the check. The check fails if the metric value is less than the specified threshold value.",
            "type": "number"
          },
          "must_be_less_than_or_equal": {
            "description": "Specifies the threshold for the check. The check fails if the metric value is less than or equal to the specified threshold value.",
            "type": "number"
          },
          "must_be_between": {
            "description": "Specifies a threshold range for the check. The check fails if the metric value is between a minimum and maximum value. In short style eg fail_when_between:[10,20] boundary values 10 and 20 will pass. For including boundary values, use nested min_* and max_* properties",
            "$ref": "#/$defs/numeric_range"
          },
          "must_not_be_between": {
            "description": "Specifies a threshold range for the check. The check fails if the metric value is not between a minimum and maximum value. In short style eg fail_when_between:[10,20] boundary values 10 and 20 will pass. For including boundary values, use nested min_* and max_* properties",
            "$ref": "#/$defs/numeric_range"
          }
        }
      }
    }
  }
